"use strict";const inBrowser="undefined"!=typeof window,UA=inBrowser&&window.navigator.userAgent.toLowerCase(),isIE=UA&&/msie|trident/.test(UA),isAndroid=(UA&&UA.indexOf("msie 9.0"),UA&&UA.indexOf("edge/"),UA&&0<UA.indexOf("android")),isIOS=UA&&/iphone|ipad|ipod|ios/.test(UA),isWx=(UA&&UA.match(/firefox\/(\d+)/),UA&&-1<UA.indexOf("micromessenger")),isXcx=UA&&-1<UA.indexOf("miniprogram");let supportsPassive=!1;if(inBrowser)try{const a={};Object.defineProperty(a,"passive",{get(){supportsPassive=!0}}),window.addEventListener("test-passive",null,a)}catch(e){}function isNative(e){return"function"==typeof e&&/native code/.test(e.toString())}const hasSymbol="undefined"!=typeof Symbol&&isNative(Symbol)&&"undefined"!=typeof Reflect&&isNative(Reflect.ownKeys),env=("undefined"!=typeof Set&&isNative(Set),getEnv());function checkPath(e){return e.bt=e.bt||Date.now(),e.ba=config.ba,window.encodeURI("?data="+JSON.stringify(e))}const symbolkey=Symbol(),ilogkey=hasSymbol?symbolkey:"ilog9088jhfahfjaahqwe";function ilog(e){e.a=e.a||config.a,e.ki=e.ki||"app",e.a?(e.e=e.e||env,freeCallback(()=>{window[ilogkey]=new Image,window[ilogkey].onerror=()=>{pushCacheFaileLog(e)},window[ilogkey].src=""+config.ilogUrl+checkPath(e)})):pushCacheFaileLog({...e,bt:Date.now()})}function sendBeaconHandler(e){e.a=e.a||config.a,e.ki=e.ki||"app",e.a?(e.e=e.e||env,freeCallback(()=>{window?.navigator?.sendBeacon(""+config.ilogUrl+checkPath(e))})):pushCacheFaileLog({...e,bt:Date.now()})}const cacheFaileLog=[];function resendCacheFaileLog(){var e=JSON.parse(JSON.stringify(cacheFaileLog));cacheFaileLog.length=0,e.forEach(e=>{ilog(e)})}function resendCacheFaileLogByBeacon(){var e=JSON.parse(JSON.stringify(cacheFaileLog));cacheFaileLog.length=0,e.forEach(e=>{sendBeaconHandler(e)}),cacheFaileLog.length=0}function pushCacheFaileLog(e){cacheFaileLog.push(JSON.parse(JSON.stringify(e)))}let intervaler=null;const pagehideCallbacks=[],onloadCallBacks=[];function getTargetPathByBubble(e){for(var n=[];e&&"body"!==e?.nodeName?.toLowerCase();)n.push(e),e=e.parentNode;return JSON.stringify(n.filter(e=>e!==document&&e!==window).map(e=>{var n=e.nodeName.toLowerCase();return e.className&&"string"==typeof e.className?n+"."+e.className.split(" ").join("."):n}))}function onloadCallBacksImplement(){onloadCallBacks.forEach(e=>e()),onloadCallBacks.length=0}function onloadHandle(){"complete"===document.readyState?onloadCallBacksImplement():window.addEventListener("load",onloadCallBacksImplement)}function resendIntervaler(){resendCacheFaileLog(),window.clearInterval(intervaler),config.resendInterval&&"number"==typeof config.resendInterval&&(config.resendInterval=config.resendInterval<1?10:config.resendInterval,intervaler=setInterval(resendCacheFaileLog,60*config.resendInterval*1e3))}function onloadCollecter(e){"function"==typeof e&&onloadCallBacks.push(e)}function pagehideCallbackCollecter(e){"function"==typeof e&&pagehideCallbacks.push(e)}function pagehideHandle(){window.addEventListener("pagehide",e=>{pagehideCallbacks.forEach(e=>e()),pagehideCallbacks.length=0,onloadCallBacks.length=0,window.clearInterval(intervaler),intervaler=null},!1)}function getEnv(){switch(!0){case isAndroid||isIOS||isWx:return"h5";case isXcx:return"xcx";default:return"pc"}}const freeCallbackFn="function"==typeof window.requestIdleCallback?window.requestIdleCallback:e=>setTimeout(e,0),freeCallback=e=>freeCallbackFn(e),VIEW_ASM="vsm",CLICK_ASM="csm";let config={a:"",longResourceTime:100,longApiTime:100,longTaskTime:1e3,viewAsm:VIEW_ASM,clickAsm:CLICK_ASM,mode:"dev",threshold:.5,ilogUrl:"",ba:"",resendInterval:10};function initIlogConfig(e){config={...config,...e},e.ilogUrl?resendIntervaler():console.error("ilogUrl is must !")}const threshold=config["threshold"],THRESHOLD="number"==typeof threshold&&0<=threshold&&threshold<=1?threshold:.5,options$1={root:null,rootMargin:"0px",threshold:THRESHOLD};function observeHandler({entry:e,target:n,ob:t}){e.intersectionRatio>=THRESHOLD&&(ilog({asm:n.getAttribute(config.viewAsm),et:"view",ki:"app"}),t.unobserve(n),n.removeAttribute(""+config.viewAsm))}function imgCompleteHandler({entry:e,target:n,ob:t},r=1){n?.complete?observeHandler({entry:e,target:n,ob:t}):0<r?(r--,setTimeout(()=>{imgCompleteHandler({entry:e,target:n,ob:t},r)},500)):t.unobserve(n)}const iscObserver=new IntersectionObserver(async function(e,t){e.forEach(async function(e){var n=e["target"];"img"===n?.tagName.toLowerCase()?imgCompleteHandler({entry:e,target:n,ob:t},1):observeHandler({entry:e,target:n,ob:t})})},options$1);function isVisible(e){return 1===e?.nodeType&&"none"!==e?.style?.display&&"hidden"!==e?.style?.visibility&&"0"!==e?.style?.opacity}function parseNode(e){isVisible(e)&&!e.getAttribute("ilog_intersectionObserver_tag")&&(e.setAttribute("ilog_intersectionObserver_tag","1"),iscObserver.observe(e))}function collectTargets(){var e=Array.from(document.querySelectorAll(`[${config.viewAsm}]`)).filter(e=>e?.getAttribute(""+config.viewAsm));0<e.length&&e.forEach(e=>parseNode(e))}const observer=new(window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver)(async function(e){e.forEach(async function(e){var n=e["target"];"childList"===e.type&&e?.addedNodes?.length?collectTargets():"attributes"===e.type&&n?.getAttribute(""+config.viewAsm)&&parseNode(n)})}),options={subtree:!0,attributes:!0,childList:!0,attributeFilter:[""+config.viewAsm,"style"]},isCanUseMutationObserver=!isIE&&"undefined"!=typeof MutationObserver&&(isNative(MutationObserver)||"[object MutationObserverConstructor]"===MutationObserver.toString()),isCanUseIntersectionObserver=!isIE&&"undefined"!=typeof IntersectionObserver&&(isNative(IntersectionObserver)||"[object IntersectionObserverConstructor]"===IntersectionObserver.toString());function mutationRun(){isCanUseMutationObserver&&isCanUseIntersectionObserver&&observer.observe(document.body,options)}function removeMutation(){isCanUseMutationObserver&&isCanUseIntersectionObserver&&(observer.disconnect(),iscObserver.disconnect())}let lastClickEvent=void 0;function clickHandler(e){e=(lastClickEvent=e).target;null!==e?.getAttribute(""+config.clickAsm)&&ilog({ki:"app",et:"click",asm:e?.getAttribute(""+config.clickAsm)})}function inputHandler(e){lastClickEvent=e}function pageStopTime(){const e=Date.now();onloadCollecter(()=>{}),pagehideCallbackCollecter(()=>{sendBeaconHandler({ki:"app",et:"timing",hr:window.location.origin,ext:{timing:Date.now()-e}})})}function removeListener$1(){window.removeEventListener("click",clickHandler),window.removeEventListener("input",inputHandler),lastClickEvent=void 0}function uxObserveRun(e){e&&!e.includes("click")||window.addEventListener("click",clickHandler),e&&!e.includes("input")||window.addEventListener("input",inputHandler),e&&!e.includes("pageusetime")||pageStopTime()}const LONG_RESOURCE_TIME=30,LONG_API_TIME=50,LONG_TASK_TIME=50,isCanUsePerformanceObserver="undefined"!=typeof IntersectionObserver&&(isNative(IntersectionObserver)||"[object IntersectionObserverConstructor]"===IntersectionObserver.toString());let perfObserver;function isCache(e){return 0===e.transferSize||0!==e.transferSize&&0===e.encodedBodySize}function longTask(e){e.getEntriesByType("longtask").filter(e=>e.duration>(config.longTaskTime||LONG_TASK_TIME)).forEach(e=>{ilog({ki:"per",ext:{perType:"longTask",eventType:lastClickEvent?.type,duration:Math.round(e.duration),selector:lastClickEvent?getTargetPathByBubble(lastClickEvent?.target):""}})})}function longApi(e){e.getEntriesByType("resource").filter(e=>-1<["fetch","xmlhttprequest"].indexOf(e.initiatorType)&&e.duration>(config.longApiTime||LONG_API_TIME)).forEach(e=>{ilog({ki:"per",ext:{perType:"longApi",data:{duration:Math.round(e.duration),url:encodeURIComponent(e.name)}}})})}function longResource(e){let n=[];for(e.getEntriesByType("resource").filter(e=>-1===["fetch","xmlhttprequest","beacon"].indexOf(e?.initiatorType)&&e.duration>(config.longResourceTime||LONG_RESOURCE_TIME)).forEach(e=>{e.name.includes(config.ilogUrl)||n.push({isCache:isCache(e),url:encodeURIComponent(e.name),duration:Math.round(e.duration),initiatorType:e.initiatorType||""})});n.length;)ilog({ki:"per",ext:{perType:"longResource",data:n.splice(0,20)}})}function cruxTarget(){var e,n,t,r,o,i;performance.timing&&({responseStart:o,navigationStart:e,responseEnd:i,domContentLoadedEventEnd:n,domInteractive:t,loadEventEnd:r}=performance.timing,i={whiteScreen:o-e,firstPackage:i-e,firstScreen:(o=performance.getEntriesByName("first-contentful-paint")[0])?.startTime,htmlLoad:n-e,firstUx:t-e,pageLoad:r-e,FCP:o,timing:performance.timing},ilog({ki:"per",ua:navigator.userAgent,ext:{perType:"crux",data:i}}))}function memoryHandler({sendBeacon:e}){var n=performance["memory"];n&&(e?sendBeaconHandler:ilog)({ki:"per",ua:navigator.userAgent,ext:{perType:"memory",data:n}})}function usePerfObserver(n){(perfObserver=new PerformanceObserver(e=>{n&&!n.includes("longApi")||longApi(e),n&&!n.includes("longResource")||longResource(e),n&&!n.includes("longTask")||longTask(e)})).observe({entryTypes:["resource","longtask"]})}function perfObserveRun(e){isCanUsePerformanceObserver&&usePerfObserver(e),e&&!e.includes("memory")||(onloadCollecter(()=>memoryHandler({})),pagehideCallbackCollecter(()=>memoryHandler({sendBeacon:!0}))),e&&!e.includes("crux")||onloadCollecter(()=>freeCallback(cruxTarget))}function removeObersve(){perfObserver?.disconnect()}function onerrorFn(){window.onerror=function(e,n,t,r,o){ilog({ki:"err",ext:{errType:"jsErr",filename:n,position:t+"."+r,message:"string"==typeof e?e:"",stack:o?.stack?.slice(0,100)}})}}function resourceErrListener(e){e=e.target;(e?.src||e?.href)&&ilog({ki:"err",ext:{errType:"resourceErr",filename:e?.src||e?.href,tagName:e?.tagName.toLowerCase()}})}function unhandledrejectionFn(e){e.preventDefault()}function errorObserveRun(){onerrorFn(),window.addEventListener("error",resourceErrListener),window.addEventListener("unhandledrejection",unhandledrejectionFn)}function removeListener(){window.removeEventListener("unhandledrejection",unhandledrejectionFn),window.removeEventListener("error",resourceErrListener)}function removeObserveOnleave(){pagehideCallbackCollecter(()=>{removeMutation(),removeListener(),removeObersve(),removeListener$1()})}function autoAllObserve(){errorObserveRun(),mutationRun(),perfObserveRun(),uxObserveRun(),removeObserveOnleave()}onloadHandle(),pagehideHandle(),pagehideCallbackCollecter(resendCacheFaileLogByBeacon),exports.autoAllObserve=autoAllObserve,exports.errorObserveRun=errorObserveRun,exports.ilog=ilog,exports.initIlogConfig=initIlogConfig,exports.mutationRun=mutationRun,exports.pagehideCallbackCollecter=pagehideCallbackCollecter,exports.perfObserveRun=perfObserveRun,exports.removeObserveOnleave=removeObserveOnleave,exports.sendBeaconHandler=sendBeaconHandler,exports.uxObserveRun=uxObserveRun;
